# D√©monstration: POC Rapide vs Entreprise Laravel

## Sc√©nario: "Cr√©e une fonction pour valider un email et l'enregistrer"

---

## üöÄ MODE POC RAPIDE

### Mon Comportement
```
Contexte derni√®re session:
- Projet: API Laravel 
- Derni√®re action: Setup routes de base
- √âtat: Fonctionnel

Je cr√©e la fonction de validation email.
```

### Code Produit
```php
// app/Http/Controllers/EmailController.php
function saveEmail(Request $request) {
    $email = $request->email;
    
    // Validation basique
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        return response()->json(['error' => 'Invalid email'], 400);
    }
    
    // Save to DB
    DB::table('emails')->insert([
        'email' => $email,
        'created_at' => now()
    ]);
    
    return response()->json(['status' => 'saved']);
}

// Route ajout√©e
Route::post('/email', 'EmailController@saveEmail');
```

**Ma r√©ponse:** "Fait. Route `/email` disponible. Commit fait (8 min)."

### Caract√©ristiques Mode POC
- ‚úÖ **Temps**: 30 secondes
- ‚úÖ **Lignes de code**: 15
- ‚úÖ **Fonctionne**: Oui
- ‚ùå **Tests**: 0
- ‚ùå **PSR-12**: Non respect√©
- ‚ùå **S√©curit√©**: Injection SQL possible
- ‚ùå **DocBlock**: Absent

---

## üè¢ MODE ENTREPRISE LARAVEL

### Mon Comportement
```
Bonjour, j'analyse votre demande de validation et enregistrement d'email.

Questions pr√©liminaires:
1. Usage: Newsletter, compte utilisateur, ou autre?
2. Double opt-in requis?
3. RGPD: Besoin de consentement explicite?
4. D√©duplication: Email unique obligatoire?

Architecture propos√©e:
- Form Request pour validation
- Service pour logique m√©tier
- Repository pour persistence
- Job pour envoi email confirmation
- Tests unitaires et d'int√©gration

Cette approche vous convient-elle?
```

*[Apr√®s validation de l'utilisateur]*

### Test d'Abord (TDD)
```php
<?php

declare(strict_types=1);

namespace Tests\Unit\Services;

use App\Services\EmailService;
use App\Repositories\EmailRepository;
use Tests\TestCase;
use Mockery;

/**
 * @covers \App\Services\EmailService
 * @group  email
 */
class EmailServiceTest extends TestCase
{
    private EmailService $service;
    private MockInterface $repositoryMock;

    protected function setUp(): void
    {
        parent::setUp();
        
        $this->repositoryMock = Mockery::mock(EmailRepository::class);
        $this->service = new EmailService($this->repositoryMock);
    }

    /**
     * @test
     * @testdox Enregistre un email valide avec succ√®s
     */
    public function it_saves_valid_email_successfully(): void
    {
        // Arrange
        $email = 'test@example.com';
        $this->repositoryMock
            ->shouldReceive('exists')
            ->with($email)
            ->once()
            ->andReturn(false);
            
        $this->repositoryMock
            ->shouldReceive('save')
            ->with($email)
            ->once()
            ->andReturn(true);

        // Act
        $result = $this->service->registerEmail($email);

        // Assert
        $this->assertTrue($result);
    }

    /**
     * @test
     * @testdox Rejette un email d√©j√† enregistr√©
     */
    public function it_rejects_duplicate_email(): void
    {
        // Arrange
        $email = 'existing@example.com';
        $this->repositoryMock
            ->shouldReceive('exists')
            ->with($email)
            ->once()
            ->andReturn(true);

        // Assert & Act
        $this->expectException(DuplicateEmailException::class);
        $this->service->registerEmail($email);
    }
}
```

### Form Request
```php
<?php

declare(strict_types=1);

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

/**
 * Validation pour l'enregistrement d'email
 * 
 * @package App\Http\Requests
 * @author  Development Team
 * @since   1.0.0
 */
final class StoreEmailRequest extends FormRequest
{
    /**
     * D√©termine si l'utilisateur est autoris√©
     * 
     * @return bool
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * R√®gles de validation
     * 
     * @return array<string, mixed>
     */
    public function rules(): array
    {
        return [
            'email' => [
                'required',
                'email:rfc,dns',
                'max:255',
                'unique:emails,email'
            ],
            'consent' => [
                'required',
                'boolean',
                'accepted'
            ],
            'source' => [
                'nullable',
                'string',
                'in:website,api,mobile'
            ]
        ];
    }

    /**
     * Messages d'erreur personnalis√©s
     * 
     * @return array<string, string>
     */
    public function messages(): array
    {
        return [
            'email.required' => 'L\'adresse email est obligatoire.',
            'email.email' => 'L\'adresse email doit √™tre valide.',
            'email.unique' => 'Cette adresse email est d√©j√† enregistr√©e.',
            'consent.accepted' => 'Vous devez accepter les conditions.'
        ];
    }
}
```

### Service
```php
<?php

declare(strict_types=1);

namespace App\Services;

use App\Repositories\EmailRepository;
use App\Events\EmailRegistered;
use App\Exceptions\DuplicateEmailException;
use Illuminate\Support\Facades\Log;

/**
 * Service de gestion des emails
 * 
 * G√®re l'enregistrement et la validation des emails
 * avec respect du RGPD et double opt-in.
 * 
 * @package App\Services
 * @author  Development Team
 * @since   1.0.0
 */
final class EmailService
{
    /**
     * @param EmailRepository $repository
     */
    public function __construct(
        private readonly EmailRepository $repository
    ) {
    }

    /**
     * Enregistre un nouvel email
     * 
     * @param  string $email   Email √† enregistrer
     * @param  array  $metadata Donn√©es additionnelles
     * @return bool            Succ√®s de l'op√©ration
     * @throws DuplicateEmailException Si email existe
     */
    public function registerEmail(string $email, array $metadata = []): bool
    {
        // V√©rification unicit√©
        if ($this->repository->exists($email)) {
            Log::warning('Tentative d\'enregistrement email dupliqu√©', [
                'email' => $email,
                'ip' => request()->ip()
            ]);
            
            throw new DuplicateEmailException(
                'Email already registered: ' . $email
            );
        }

        try {
            // Enregistrement
            $result = $this->repository->save($email, $metadata);
            
            // Event pour d√©clencher double opt-in
            event(new EmailRegistered($email));
            
            Log::info('Email enregistr√© avec succ√®s', [
                'email' => $email,
                'source' => $metadata['source'] ?? 'unknown'
            ]);
            
            return $result;
            
        } catch (\Exception $e) {
            Log::error('Erreur enregistrement email', [
                'email' => $email,
                'error' => $e->getMessage()
            ]);
            
            throw $e;
        }
    }
}
```

### Controller
```php
<?php

declare(strict_types=1);

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Http\Requests\StoreEmailRequest;
use App\Services\EmailService;
use Illuminate\Http\JsonResponse;
use App\Exceptions\DuplicateEmailException;

/**
 * Controller pour la gestion des emails
 * 
 * @package App\Http\Controllers\Api
 * @author  Development Team
 * @since   1.0.0
 */
final class EmailController extends Controller
{
    /**
     * @param EmailService $emailService
     */
    public function __construct(
        private readonly EmailService $emailService
    ) {
    }

    /**
     * Enregistre un nouvel email
     * 
     * @param  StoreEmailRequest $request Requ√™te valid√©e
     * @return JsonResponse               R√©ponse JSON
     */
    public function store(StoreEmailRequest $request): JsonResponse
    {
        try {
            $validated = $request->validated();
            
            $this->emailService->registerEmail(
                email: $validated['email'],
                metadata: [
                    'source' => $validated['source'] ?? 'api',
                    'ip' => $request->ip(),
                    'user_agent' => $request->userAgent(),
                    'consent_given_at' => now()
                ]
            );
            
            return response()->json([
                'success' => true,
                'message' => 'Email enregistr√©. V√©rifiez votre bo√Æte mail.'
            ], 201);
            
        } catch (DuplicateEmailException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Cet email est d√©j√† enregistr√©.'
            ], 409);
            
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Une erreur est survenue.'
            ], 500);
        }
    }
}
```

### V√©rifications
```
‚úÖ PSR-12: Pass (vendor/bin/pint)
‚úÖ Static Analysis: Pass (PHPStan level 8)
‚úÖ Tests: 100% coverage
‚úÖ Security: Injection SQL impossible (Eloquent)
‚úÖ RGPD: Consentement + logs
‚úÖ Pre-commit hooks: All green

Souhaitez-vous que je cr√©e √©galement:
1. Migration pour la table emails?
2. Job pour double opt-in?
3. Tests d'int√©gration API?
```

---

## üìä COMPARAISON FINALE

| Crit√®re | Mode POC | Mode Entreprise |
|---------|----------|-----------------|
| **Temps d√©veloppement** | 30 secondes | 30 minutes |
| **Lignes de code** | 15 | 300+ |
| **Fichiers cr√©√©s** | 1 | 8 |
| **Tests** | 0 | 5+ |
| **Coverage** | 0% | 100% |
| **PSR-12** | ‚ùå Non | ‚úÖ Strict |
| **S√©curit√©** | ‚ùå Faille SQL | ‚úÖ S√©curis√© |
| **Documentation** | ‚ùå Aucune | ‚úÖ Compl√®te |
| **Maintenabilit√©** | Faible | Excellente |
| **Scalabilit√©** | Nulle | Haute |
| **RGPD Compliant** | ‚ùå Non | ‚úÖ Oui |
| **Questions pos√©es** | 0 | 5+ |
| **Confirmations demand√©es** | 0 | 3+ |

## üéØ Quand Utiliser Chaque Mode

### POC Rapide
- MVP pour lever des fonds
- D√©mo client demain
- Test d'API externe
- Script one-shot
- Prototype jetable

### Entreprise Laravel
- Code production
- Client grand compte
- Audit pr√©vu
- √âquipe 5+ devs
- Maintenance long terme
- Conformit√© l√©gale

## üîÑ Activation

```bash
# Pour un POC rapide
./jean-claude-v2/activate.sh poc-rapide

# Pour un projet client
./jean-claude-v2/activate.sh entreprise-laravel
```

**La diff√©rence est RADICALE. Je deviens une personne compl√®tement diff√©rente selon le profil!**